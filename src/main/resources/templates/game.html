<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Игра</title>
    <link href="webjars/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"></link>
    <link th:href="@{/css/common.css}" rel="stylesheet"></link>
</head>
<body>
<div th:replace="fragments/navigation :: nav-for-game"></div>
<div class="container" style="width: 1900px;">
    <!--/*@thymesVar id="user" type="dyn.model.User"*/-->
    <!--/*@thymesVar id="family" type="dyn.model.Family"*/-->

    <th:block th:if="${family.getLevel() == 0}">
        <div class="alert alert-success" style="margin-left: 100px; margin-right: 100px;">
            Итак, вы начали игру. Почти все элементы окна имеют всплывающие подсказки, просто наведите курсор. Сверху панель меню, внизу панель с деньгами, ресурсами и крафт-баллами. <br/>
            Сейчас на основателе вашей династии висит бафф "
            <th:block th:text="#{buffs.title.sevenChildren}"></th:block>
            " (значок слева от портрета). Это означает, что в первом поколении количество детей и их пол предопределены.
            Все остальные черты наследуется от родителей в равной вероятности. Также этот бафф дает старшему сыну генную модификацию (одна из частей тела будет не такая, как у человека).<br/>
            Пожалуйста, перейдите в меню на вкладку Семья.<br/>
            После того, как разберетесь со всеми вкладками меню и у вас появится хоть какая-нибудь мебель в доме, нажмите желтую кнопку "Cледующий ход" на синей панели слева, чтобы увидеть какие дети получились у вашей первой пары!
        </div>
    </th:block>
    <th:block th:if="${family.getLevel() == 1}">
        <div class="alert alert-success" style="margin-left: 100px; margin-right: 100px;">
            Основатели приобрели профессию и заработали немного деньжат! А еще их призвания принесли вам ресурсы, из которых можно что-нибудь смастерить. Родились дети, все они довольно милые, да? Подробное описание событий вы можете посмотреть,
            кликнув на кнопке Лог.
            <br/>
            Первым делом вам необходимо поместить анкеты ваших дочерей в базу невест! Нажмите кнопку под портретом дочери. Стоимость выкупа назначается вами в зависимости от
            характеристик персонажа (но не меньше чем 50*уровень семьи). Следует сделать выкуп больше, если дочь имеет ГМ черты.
            Выкуп зачисляется на ваш счет, когда кто-нибудь из игроков выберет вашу невесту (одна из основных статей дохода!).<br/>
            Теперь необходимо выбрать невест для сыновей. Нажмите кнопку под портретом сына. <br/>
            После выбора невест, вы можете выбрать баффы для пары, которые помогут немного скорректировать случайный выбор. Советуем выбрать бафф "Доминант отца" для старшего сына, чтобы повысить вероятность перехода его ГМ-черты к детям. Не
            помешает и бафф "Плодовитость", увеличивающий количество детей. К паре можно применить бафф "Генетическая модификация", который увеличивает вероятность появления ГМ-черт. Эти баффы подарены вам для начала игры, потом вам придется
            покупать их на вкладке "Город". Например, бафф "Плодовитость" можно приобрести, посетив парк отдыха.<br/>

        </div>
    </th:block>

    <div style="background-color: #2b669a; border-radius: 4px; position: fixed; top: 55px; left: 5px; padding: 5px;">
        <div th:alt-title="${'Можно запостить анкет невест: ' + bridesNum}">
            <img th:src="@{'/graphics/family_status_bride.png' }" height="35px" width="35px"></img>
            <span class="badge" style="background-color: white; color: black;" id="bridesNum"><th:block th:text="${bridesNum}"></th:block></span>
        </div>
        <div th:alt-title="${'Можно создать пар: ' + pairsNum}">
            <img th:src="@{'/graphics/family_status_married.png' }" height="35px" width="35px"></img>
            <span class="badge" style="background-color: white; color: black;" id="pairsNum"><th:block th:text="${pairsNum}"></th:block></span>
        </div>
        <th:block th:if="${#maps.size(buffsFamily) gt 0}">
            <hr/>
            <th:block th:each="mapEntry : ${buffsFamily}" th:with="project = ${mapEntry.getKey()}, items = ${mapEntry.getValue()}">
                <th:block th:if="${project.getId() eq @const.PROJECT_PAIR_ONE_MORE}">
                    <form th:action="@{/game/applyItemFamily}" method="post" class="form-inline">
                        <img th:src="@{'/graphics/family_buffs_one_more_pair.png' }" height="35px" width="35px" th:alt-title="${'Бафф: +1 пара на ход'}"></img>
                        <span class="badge" style="background-color: white; color: black;"><th:block th:text="${#lists.size(items)}"></th:block></span>
                        <input type="hidden" name="itemId" th:value="${items.get(0).getId()}"/>
                        <button type="submit" class="btn btn-success btn-xs" th:alt-title="'Применить'"><span class="glyphicon glyphicon-share-alt"></span></button>
                    </form>
                </th:block>
                <th:block th:if="${project.getId() eq @const.PROJECT_BRIDE_ONE_MORE}">
                    <form th:action="@{/game/applyItemFamily}" method="post" class="form-inline">
                        <input type="hidden" name="itemId" th:value="${items.get(0).getId()}"/>
                        <img th:src="@{'/graphics/family_buffs_one_more_bride.png' }" height="35px" width="35px" th:alt-title="${'Бафф: +1 невеста на ход'}"></img>
                        <span class="badge" style="background-color: white; color: black;"><th:block th:text="${#lists.size(items)}"></th:block></span>
                        <button type="submit" class="btn btn-success btn-xs" th:alt-title="'Применить'"><span class="glyphicon glyphicon-share-alt"></span></button>
                    </form>
                </th:block>
            </th:block>
        </th:block>
        <hr/>
        <form th:action="@{/game/turn}" method="post">
            <button class="btn btn-warning center-block" type="submit" name="turn"
                    th:alt-title="#{game.turn}" style="margin-bottom: 10px; margin-top: 10px; width: 40px; height: 40px; border-radius: 20px;">
                <span class="glyphicon glyphicon-play-circle"></span>
            </button>
        </form>
    </div>

    <div align="center" style="margin-bottom: 5px;">
        <button data-toggle="collapse" data-target="#family-log" class="btn btn-info">
            Лог уровня <span class="glyphicon glyphicon-menu-down"></span>
        </button>
    </div>
    <div id="family-log" class="collapse">
        <!--/*@thymesVar id="familyLog" type="dyn.model.FamilyLog"*/-->
        <pre class="pre-scrollable" style="height: 150px; max-height: 150px; margin-left: 100px; margin-right: 100px;" th:utext="${familyLog?.getText()}"></pre>
    </div>


    <th:block th:each="mapEntry : ${fathers}" th:with="father = ${mapEntry.getKey()}, mother=${father.getSpouse()}, childList = ${mapEntry.getValue()},
                buffsForParentsIsEmpty = ${#maps.isEmpty(buffsForParents)}, buffsMarriedIsEmpty = ${#maps.isEmpty(buffsMarried)},
                buffsSkillImprovementIsEmpty = ${#maps.isEmpty(buffsSkillImprovement)}, buffsForChildrenChangeIsEmpty = ${#maps.isEmpty(buffsForChildrenChange)} ">
        <!--/*@thymesVar id="father" type="dyn.model.Character"*/-->
        <a th:name="${'char'+father.getId()}" class="anchor"></a>
        <div align="center">
            <div class="well" style="display: inline-block; padding: 5px;background-color: #dff0d8; border: solid 1px mediumseagreen">
                <div style="display: inline-block;">
                    <th:block th:replace="fragments/char :: char-panel (character=${father})"></th:block>
                    <div class="dropup">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                style="width: 180px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;" th:disabled="${buffsForParentsIsEmpty}">
                            <!--${isAdmin} ? adminclass : userclass-->
                            Действия <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" style="width: 300px; font-size: 12px;">
                            <th:block th:replace="fragments/char :: li-for-buff-parents (character=${father}, projectItemsMap = ${buffsForParents})"></th:block>
                        </ul>
                    </div>
                </div>
                <div style="display: inline-block;">
                    <th:block th:replace="fragments/char :: char-panel (character=${mother})"></th:block>
                    <div class="dropup">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                style="width: 180px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;" th:disabled="${buffsForParentsIsEmpty}">
                            Действия <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" style="width: 300px; font-size: 12px;">
                            <th:block th:replace="fragments/char :: li-for-buff-parents (character=${mother}, projectItemsMap = ${buffsForParents})"></th:block>
                        </ul>
                    </div>
                </div>
            </div>
            <br/>
            <th:block th:each="child : ${childList}" th:with="spouse = ${child.getSpouse()}, sex = ${child.getSex()},
            mainButton1 = ${sex == 'male' and spouse == null and family.getPairsNum() lt family.getHouse().getPairsNum()},
            mainButton2 = ${sex == 'female' and spouse == null and child.isFiancee() == false and family.getFianceeNum() lt family.getHouse().getFianceeNum()}">
                <div class="well" style="display: inline-block; padding: 5px;" th:styleappend="${spouse != null?'background-color: #dff0d8; border: solid 1px mediumseagreen':''}">
                    <!--/*@thymesVar id="child" type="dyn.model.Character"*/-->
                    <div style="display: inline-block;">
                        <th:block th:replace="fragments/char :: char-panel (character=${child})"></th:block>
                        <table>
                            <tr>
                                <td>
                                    <!-- выбрать невесту -->
                                    <th:block th:if="${mainButton1}">
                                        <form th:action="@{/game/chooseFiancee}" method="get" class="form-inline" style="margin-left: 5px;">
                                            <input type="hidden" name="characterId" th:value="${child.getId()}"/>
                                            <button class="btn btn-success btn-xs" type="submit" name="chooseFianceeButton" th:id="${child.getId()}"
                                                    th:title="'Можно создать еще пар: '+${family.getHouse().getPairsNum()-family.getPairsNum()}"
                                                    style="width: 105px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 0px; ">
                                                Выбрать невесту
                                            </button>
                                        </form>
                                    </th:block>
                                    <!-- запостить анкету невесты -->
                                    <th:block th:if="${mainButton2}">
                                        <form th:action="@{/game/putUpForFiancee}" method="post" class="form-inline" style="margin-left: 5px;">
                                            <input type="hidden" name="female" th:value="${child.getId()}"/>
                                            <button class="btn btn-warning btn-xs" type="submit" name="postFianceeButton" th:id="${child.getId()}"
                                                    th:title="'Опубликовать анкету невесты. Можно опубликовать еще анкет: '+${family.getHouse().getFianceeNum()-family.getFianceeNum()}"
                                                    style="width: 105px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 0px; ">
                                                <span class="glyphicon glyphicon-cloud-upload"></span>&nbsp;+&nbsp;<th:block th:text="${family.getLevel()*child.getRaceCoefficient()}*50"></th:block>&nbsp;д.
                                            </button>
                                        </form>
                                    </th:block>
                                </td>
                                <td>
                                    <div class="dropup" th:with="childSex = ${child.getSex()}, childSpouse = ${child.getSpouse()},
                                        isCoupledDaughter = ${childSex == 'female' and (childSpouse != null or child.isFiancee() == true)},
                                        isFreeDaughter = ${childSex == 'female' and childSpouse == null and child.isFiancee() == false},
                                        isMarriedSon = ${childSex == 'male' and childSpouse != null},
                                        isFreeSon = ${childSex == 'male' and childSpouse == null}">
                                        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" th:name="${'actionsFor'+child.getId()}"
                                                style="width: 180px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; "
                                                th:styleappend="${(mainButton1 or mainButton2)?'width: 80px;border-bottom-left-radius: 0px; ':''}"
                                                th:disabled="${isCoupledDaughter or
                                                    (isFreeDaughter and buffsSkillImprovementIsEmpty and buffsForChildrenChangeIsEmpty) or
                                                    (isMarriedSon and buffsMarriedIsEmpty and buffsSkillImprovementIsEmpty and buffsForChildrenChangeIsEmpty) or
                                                    (isFreeSon and buffsSkillImprovementIsEmpty and buffsForChildrenChangeIsEmpty)}">
                                            Действия <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" style="width: 330px; font-size: 12px;">

                                            <th:block th:if="${child.getSex() == 'male' or isFreeDaughter}">
                                                <!--Баффы на женатого сына-->
                                                <th:block th:if="${isMarriedSon}">
                                                    <th:block th:replace="fragments/char :: li-for-buff-married (character=${child}, projectItemsMap = ${buffsMarried})"></th:block>
                                                    <li role="separator" class="divider"></li>
                                                </th:block>
                                                <!--Баффы навыков и карьеры-->
                                                <th:block th:replace="fragments/char :: li-for-buff-improve-skill (character=${child}, projectItemsMap = ${buffsSkillImprovement})"></th:block>
                                                <!--Изменение-->
                                                <th:block th:replace="fragments/char :: li-for-buff-change (character=${child}, projectItemsMap = ${buffsForChildrenChange})"></th:block>
                                            </th:block>

                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <th:block th:if="${spouse != null}">
                        <div style="display: inline-block;">
                            <th:block th:replace="fragments/char :: char-panel (character=${spouse})"></th:block>
                            <table>
                                <tr>
                                    <td>
                                        <div class="dropup">
                                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                                    style="width: 180px; border-top-right-radius: 0; border-top-left-radius: 0; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;"
                                                    th:disabled="${spouse.getSex() == 'male' or (spouse.getSex() == 'female' and
                                                    (buffsSkillImprovementIsEmpty and buffsForChildrenChangeIsEmpty))}">
                                                Действия <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu" style="width: 330px; font-size: 12px;">
                                                <th:block th:if="${spouse.getSex() == 'female'}">
                                                    <!--Баффы навыков и карьеры-->
                                                    <th:block th:replace="fragments/char :: li-for-buff-improve-skill (character=${spouse}, projectItemsMap = ${buffsSkillImprovement})"></th:block>
                                                    <!--Изменение-->
                                                    <th:block th:replace="fragments/char :: li-for-buff-change (character=${spouse}, projectItemsMap = ${buffsForChildrenChange})"></th:block>
                                                </th:block>
                                                <!--
                                                <li><a href="#">Another action</a></li>
                                                <li><a href="#">Something else here</a></li>
                                                <li role="separator" class="divider"></li>
                                                <li><a href="#">Separated link</a></li>
                                                -->
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </th:block>
                </div>
            </th:block>
        </div>
        <hr style="height: 1px; size: 2px; color: black;border-width: 4px;" size="2px"/>
    </th:block>

</div>

<th:block th:replace="fragments/scripts :: webjars"></th:block>
<script>
    $('.dropdown-menu').find('form').click(function (e) {
        e.stopPropagation();
    });
</script>
</body>
</html>